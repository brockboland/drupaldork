<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN"
  "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" version="XHTML+RDFa 1.0" dir="ltr"
  xmlns:content="http://purl.org/rss/1.0/modules/content/"
  xmlns:dc="http://purl.org/dc/terms/"
  xmlns:foaf="http://xmlns.com/foaf/0.1/"
  xmlns:og="http://ogp.me/ns#"
  xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
  xmlns:sioc="http://rdfs.org/sioc/ns#"
  xmlns:sioct="http://rdfs.org/sioc/types#"
  xmlns:skos="http://www.w3.org/2004/02/skos/core#"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema#">

<head profile="http://www.w3.org/1999/xhtml/vocab">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../../misc/favicon.ico" type="image/vnd.microsoft.icon" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
<link rel="alternate" type="application/rss+xml" title="Drupal Dork RSS" href="../../rss.xml" />
  <title>Posts from May 2011 | Drupal Dork</title>
  <link type="text/css" rel="stylesheet" href="../../sites/default/files/css/css_pbm0lsQQJ7A7WCCIMgxLho6mI_kBNgznNUWmTWcnfoE.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/default/files/css/css_VPGZk7E9DmTpTZ-olsKmvUbPc-V3DOyRouMVA8jM4Jg.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/default/files/css/css_Wu8npAzy16WmnnnWKxpexfgsAryolGGaX6yO3GWA5bU.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/default/files/css/css_DA76D3kkHaT_VUm3Aj1Txz0yCM9z9qrYjWlPOR-gAwk.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/default/files/css/css_2THG1eGiBIizsWFeexsNe1iDifJ00QRS9uSd03rY9co.css" media="print" />

<!--[if lte IE 7]>
<link type="text/css" rel="stylesheet" href="http://drupaldork.com/themes/bartik/css/ie.css?mrsb48" media="all" />
<![endif]-->

<!--[if IE 6]>
<link type="text/css" rel="stylesheet" href="http://drupaldork.com/themes/bartik/css/ie6.css?mrsb48" media="all" />
<![endif]-->
  <script type="text/javascript" src="../../sites/default/files/js/js_xAPl0qIk9eowy_iS9tNkCWXLUVoat94SQT48UBCFkyQ.js"></script>
<script type="text/javascript" src="../../sites/default/files/js/js_lgAAOlplEun7p_8Pb-8dM079wtvnfwLZ0hAK0mH7Dto.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var _gaq = _gaq || [];_gaq.push(["_setAccount", "UA-248277-13"]);_gaq.push(["_trackPageview"]);(function() {var ga = document.createElement("script");ga.type = "text/javascript";ga.async = true;ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga, s);})();
//--><!]]>
</script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"brocktik","theme_token":"YGMtUTqy93CE7wsHXs5jGhvLNvz-HTj-0tdGRqTZyHA","js":{"misc\/jquery.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"sites\/all\/modules\/contrib\/google_analytics\/googleanalytics.js":1,"0":1},"css":{"modules\/system\/system.base.css":1,"modules\/system\/system.menus.css":1,"modules\/system\/system.messages.css":1,"modules\/system\/system.theme.css":1,"modules\/comment\/comment.css":1,"sites\/all\/modules\/contrib\/date\/date_api\/date.css":1,"sites\/all\/modules\/contrib\/date\/date_popup\/themes\/datepicker.1.7.css":1,"modules\/field\/theme\/field.css":1,"sites\/all\/modules\/contrib\/mollom\/mollom.css":1,"modules\/node\/node.css":1,"modules\/search\/search.css":1,"modules\/user\/user.css":1,"sites\/all\/modules\/contrib\/views\/css\/views.css":1,"sites\/all\/modules\/contrib\/ctools\/css\/ctools.css":1,"themes\/bartik\/css\/layout.css":1,"themes\/bartik\/css\/style.css":1,"themes\/bartik\/css\/colors.css":1,"themes\/bartik\/css\/print.css":1,"themes\/bartik\/css\/ie.css":1,"themes\/bartik\/css\/ie6.css":1}},"googleanalytics":{"trackOutbound":1,"trackMailto":1,"trackDownload":1,"trackDownloadExtensions":"7z|aac|arc|arj|asf|asx|avi|bin|csv|doc|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls|xml|z|zip"}});
//--><!]]>
</script>
</head>
<body class="html not-front not-logged-in one-sidebar sidebar-second page-archive page-archive- page-archive-2011 page-archive- page-archive-05" >
  <div id="skip-link">
    <a href="05.html#main-content" class="element-invisible element-focusable">Skip to main content</a>
  </div>
    <div id="page-wrapper"><div id="page">

  <div id="header" class="without-secondary-menu"><div class="section clearfix">

          <a href="../../index.html" title="Home" rel="home" id="logo">
        <img src="../../sites/all/themes/brocktik/logo.png" alt="Home" />
      </a>
    
          <div id="name-and-slogan">

                              <div id="site-name">
              <strong>
                <a href="../../index.html" title="Home" rel="home"><span>Drupal Dork</span></a>
              </strong>
            </div>
                  
                  <div id="site-slogan">
            Drupal: pretty great.          </div>
        
      </div> <!-- /#name-and-slogan -->
    
      <div class="region region-header">
    <div id="block-search-form" class="block block-search">

    
  <div class="content">
    <form action="05.html" method="post" id="search-block-form" accept-charset="UTF-8"><div><div class="container-inline">
      <h2 class="element-invisible">Search form</h2>
    <div class="form-item form-type-textfield form-item-search-block-form">
  <label class="element-invisible" for="edit-search-block-form--2">Search </label>
 <input title="Enter the terms you wish to search for." type="text" id="edit-search-block-form--2" name="search_block_form" value="" size="15" maxlength="128" class="form-text" />
</div>
<div class="form-actions form-wrapper" id="edit-actions"><input type="submit" id="edit-submit" name="op" value="Search" class="form-submit" /></div><input type="hidden" name="form_build_id" value="form-ptgusP8d1FvW6upaTq6dyNm1w9--EsCKM8kUo0M13v8" />
<input type="hidden" name="form_id" value="search_block_form" />
</div>
</div></form>  </div>
</div>
  </div>

          <div id="main-menu" class="navigation">
        <h2 class="element-invisible">Main menu</h2><ul id="main-menu-links" class="links clearfix"><li class="menu-534 first"><a href="../../index.html" title="">Home</a></li>
<li class="menu-533"><a href="../../about.html" title="About">About</a></li>
<li class="menu-122 active-trail"><a href="../../archive.html" class="active-trail active">Archive</a></li>
<li class="menu-118 last"><a href="../../contact.html" title="">Contact</a></li>
</ul>      </div> <!-- /#main-menu -->
    
    
  </div></div> <!-- /.section, /#header -->

  
  
  <div id="main-wrapper" class="clearfix"><div id="main" class="clearfix">

          <div id="breadcrumb"><h2 class="element-invisible">You are here</h2><div class="breadcrumb"><a href="../../index.html">Home</a> » <a href="../../archive.html">Post Archives</a> » <a href="../2011.html">Posts from 2011</a></div></div>
    
    
    <div id="content" class="column instapaper_body"><div class="section">
            <a id="main-content"></a>
                    <h1 class="title" id="page-title">
          Posts from May 2011        </h1>
                          <div class="tabs">
                  </div>
                          <div class="region region-content">
    <div id="block-system-main" class="block block-system">

    
  <div class="content">
    <div class="view view-post-archive view-id-post_archive view-display-id-page view-dom-id-f8441acd9da0164ec59eb8a4a4227fef">
        
  
  
      <div class="view-content">
        <div class="views-row views-row-1 views-row-odd views-row-first">
    <div id="node-21" class="node node-post node-promoted clearfix" about="/2011/05/insanely-useful-tips-git-command-line" typeof="sioc:Item foaf:Document">

        <h2 property="dc:title" datatype="">
      <a href="../../2011/05/insanely-useful-tips-git-command-line.html">Insanely Useful Tips for Git on the Command Line</a>
    </h2>
    
      <div class="meta submitted">
            <span property="dc:date dc:created" content="2011-05-12T20:52:07-04:00" datatype="xsd:dateTime" rel="sioc:has_creator">Submitted by <span class="username" xml:lang="" about="/users/brock" typeof="sioc:UserAccount" property="foaf:name" datatype="">Brock</span> on Thu 12 May 2011, 8:52 pm</span>    </div>
  
  <div class="content clearfix">
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>I've been meaning to write something up about these for a while, because they have made my development flow so much better.</p>
<h2>Tab completion</h2>
<p>Arguably, the best thing about git is lightweight branches. But, I had been resisting using them, because it was a pain in the neck to keep track of them and re-type or copy-pasta the name for every checkout or merge. I rely heavily on tab completion in the command line, because I know I'll mistype things otherwise, and spend way too much time trying to figure out why something is broke later on - for example, after mistyping the target of a symlink.</p>
<p>As it turns out, git ships with a script to handle tab completion: you just need to find and enable it.</p>
<p>Since I use <a href="http://mxcl.github.com/homebrew/">Homebrew</a> to install and update packages (Mac users: you should too), my git executable is in <code>/usr/local/Cellar/git/1.7.3.4/bin</code>. You need to find <code>git-completion.bash</code>. In my case, it's in a sibling directory: <code>/usr/local/Cellar/git/1.7.3.4/etc/bash_completion.d/git-completion.bash</code>.</p>
<p>Once you find it, include it in your <code>.bash_profile</code>, replacing the path specified here with the location you found:</p>
<p><code><br />
# Use git auto-completion<br />
source /usr/local/Cellar/git/1.7.3.4/etc/bash_completion.d/git-completion.bash<br /></code></p>
<p>Tab completion works for git commands (reset, status, commit, etc) as well as branch names.</p>
<h2>Branch name in prompt</h2>
<p>This one would not have even occurred to me, but I came across it in <a href="http://www.lullabot.com/articles/git-best-practices-history-viewing-tips-and-displaying-branch-context#comment-8557">a comment on a Lullabot blog post about git</a>. You can show the current branch in the prompt when in a git repo directory, like this:</p>
<p><code>brockbookpro:multi_smtp (6.x-1.x) $</code></p>
<p>Again, modify your <code>.bash_profile</code> to add this:</p>
<p><code><br />
function parse_git_branch {<br />
  git branch --no-color 2&gt; /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/(\1) /'<br />
}<br />
export PS1="\h:\W \$(parse_git_branch)\$ "<br /></code></p>
<p>If you're working on a project with a lot of branches, this will make life easier.</p>
</div></div></div><div class="field field-name-taxonomy-vocabulary-1 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Category: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../../vocabulary1/git.html" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Git</a></li><li class="taxonomy-term-reference-1"><a href="../../category/tips-tricks.html" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Tips &amp; Tricks</a></li></ul></div>  </div>

  
  
</div>
  </div>
  <div class="views-row views-row-2 views-row-even views-row-last">
    <div id="node-20" class="node node-post node-promoted clearfix" about="/2011/05/dope-1-simplenews-threaded-send" typeof="sioc:Item foaf:Document">

        <h2 property="dc:title" datatype="">
      <a href="../../2011/05/dope-1-simplenews-threaded-send.html">DOPE #1: Simplenews Threaded Send</a>
    </h2>
    
      <div class="meta submitted">
            <span property="dc:date dc:created" content="2011-05-01T13:39:58-04:00" datatype="xsd:dateTime" rel="sioc:has_creator">Submitted by <span class="username" xml:lang="" about="/users/brock" typeof="sioc:UserAccount" property="foaf:name" datatype="">Brock</span> on Sun 1 May 2011, 1:39 pm</span>    </div>
  
  <div class="content clearfix">
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p><strong>tl;dr: I release <a href="http://drupal.org/project/simplenews_threaded_send">Simplenews Threaded Send</a> this weekend.</strong></p>
<p>Let me start by saying that I love working for <a href="http://www.jacksonriver.com/">Jackson River</a>. About a month ago, management anounced that we would be trying out a monthly Day of Personal Enrichment, not unlike Google's 20% time, but more realistic - who can afford to spend a day a week goofing around? We've staggered them so that the whole company doesn't shut down for a day at a time, so my first DOPE was this past Friday and I wrapped up my project over the weekend.</p>
<p>First, a little back story. Last year, we rebuilt the site of a member of the US House of Representatives. One of their larger requirments was to implement a mass-mailer that could be used to send daily updates to other party members and constituents - several thousand emails per day, in total. They had several SMTP servers that had been sending these mailings for some time, so we were able to continue using them without worrying about getting blacklisted as spammers by mail services. We decided to use the <a href="http://drupal.org/project/simplenews">Simplenews</a> and <a href="http://drupal.org/project/smtp">SMTP Authentication Support</a> modules to meet this requirement, but had to work around a few limitations:</p>
<ul><li>
		Simlpenews sends messags during cron, one message at a time.</li>
<li>
		Drupal sets a semaphore variable during a cron run to ensure that only one cron process can be running at once.</li>
<li>
		Simplenews relied on this assumption, and did nothing to mark the batch of messages that were in progress.</li>
<li>
		A bug in <a href="http://drupal.org/project/poormanscron">Poormanscron</a> exposed this problem in Simplenews: when two cron processes were allowed to run at once, <a href="http://drupal.org/node/361071">multiple copies of the messages were sent</a>.</li>
<li>
		The SMTP Authentication Support module only handled a single SMTP server.</li>
</ul><h2>
	Customizations</h2>
<p>
	To get around these limitations and assumptions, I did the following:</p>
<ul><li>
		Wrote a Multi SMTP module that allows multiple servers to be configured. It sits on top of the existing SMTP module, and just sets variables used by that module to determine which server to send mail to.</li>
<li>
		Wrote a Simplenews Threaded Send module that would start a new thread for each SMTP server. Each of these child processes would send a single batch of messages to one SMTP server.</li>
<li>
		Made some modifications to the Simplenews module to set a flag on messages that were in the process of being sent, to prevent duplicates.</li>
<li>
		Implemented other modules for some custom functionality: global unsubscribe, creating a user record for newsletter subscribers (Simplenews doesn't require a record in the users table), etc.</li>
</ul><p>
	After ironing out the kinks, this solution has been working great for the client for several months. They've been really happy, and after showing it off, told us that other offices in the House were interested in making use of it.</p>
<h2>
	DOPE project, and how it works</h2>
<p>
	Which brings us, finally, to my DOPE project: refactoring Simplenews Threaded Send for public release. Don't Hack Contrib is only one step below Don't Hack Core, so I wanted to find a way to wrap the changes I had made to Simplenews into my module so that it could be installed and used without any hacks, like requiring patches to Simplenews.</p>
<p>
	I had started this process months ago on my own time, but was never able to make time to wrap it up, so it was the perfect project for a DOPE. I spent Friday and part of this weekend moving Simplenews customizations into Simplenews Threaded Send, ripping out the functionality specific to the client, and testing the hell out of it.</p>
<p>
	At the core, this module is based on socket connections. A Thread class (written by a former co-worker) adds pseudo-threading by opening new connections to the server. For each SMTP server that's avaialable, the module will create a Thread object. When <code>start()</code> is called on the object, it opens a socket connection back to the same server, to a URL defined by this module with a callback that will send a batch of email. The Thread object writes the request headers to the socket and then returns, so that the module can continue processing without waiting for the response (which takes several seconds, since the "child" process is sending a batch of email). This way, multiple threads can be processing in parallel…sort of.</p>
<p>
	At half-second intervals, each thread is polled to see if the response has fully loaded. If it has, the Thread object is re-used to open another connection, until the whole message queue has been sent. This will work around slow SMTP servers: while the thread that's sending on the slow server waits for the batch to finish, the other threads may be able to send two or three batches. A slow server won't hold up the whole process.</p>
<p>
	If an SMTP server fails to send, it will be marked as "inactive" for four hours. This was added to prevent the module from trying over and over to use a server that's not available: occasionally, an SMTP server would get overloaded, restarted by someone else, or otherwise become unavailable for a time, so we just gave it a cooling period before attempting to use it again. Any messages that had been "claimed" by the thread for that server will be freed up after an hour, so that another server can process them during a later cron run.</p>
<h2>
	Updates and Cleanup</h2>
<p>
	Cleaning this up for release required several changes:</p>
<ul><li>
		Removed the cURL fallback method. Early on, we had some issues with SELinux on the server blocking socket connections, and had to use cURL to make the queries as a fallback method. But, I couldn't find a way to open a cURL connection and let processing continue without completing the response. I could open connections on multiple servers at one time, but had to wait for all of them to finish before sending another round of batches through. This meant that the faster servers would sit idle while a slow server was finishing its batch. Thankfully, the SELinux configuration was fixed, so this method was only in use for a little while. I didn't even want to include it in the released module, so I pulled it all out.</li>
<li>
		Moved Simplenews customizations into Simplenews Threaded Send. This meant copying some functions from Simplenews into the module to be renamed and modified slightly. For example <code>simplenews_threaded_send_get_spool()</code> is a copy of <code>simplenews_get_spool()</code>, but it marks the messages that are in process to prevent two threads from processing the same batch.</li>
<li>
		Replaced a hacky <code>$send_full_spool</code> bool flag with a proper <code>$batch_size</code> int argument. Before starting the full send process, the module will send one message on each SMTP server. This will cause unavailable servers to be marked as inactive for the next four hours, so that it won't waste time trying to process an entire batch against a server that's just timing out. This argument never really made sense, especially because it would cause the <code>simplenews_throttle</code> variable to be set to 1 for one run, then re-set to what it was before - very hacky. The new <code>$batch_size</code> argument gets passed down the processing stack, which makes it easier to override later on for other reasons.</li>
<li>
		Implemented <code>hook_schema_alter()</code> to handle new columns needed in <code>simplenews_mail_spool</code> table. Previously, these changes were just made right in the Simplenews module.</li>
</ul><p>
	While I was at it, I also updated the Multi SMTP module to give more helpful messages to admins, and to add a check for the necessary <a href="http://phpmailer.worxware.com/">PHPMailer</a> library used by the SMTP Authentication Support module. These modules can be found here:</p>
<ul><li>
		<a href="http://drupal.org/project/simplenews_threaded_send">Simplenews Threaded Send</a></li>
<li>
		<a href="http://drupal.org/project/multi_smtp">Multi SMTP</a></li>
</ul><h2>
	Release Plan</h2>
<p>
	The version of Simplenews Threaded Send that's available on drupal.org right now is marked as 6.x-1.0-beta2. While the client has been using the module successfully for a number of months, so much refactoring was done that I would like for it to get some more testing in the wild before I make a point release.</p>
</div></div></div><div class="field field-name-taxonomy-vocabulary-1 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Category: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../../category/category/contrib-modules.html" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Contrib Modules</a></li><li class="taxonomy-term-reference-1"><a href="../../category/dope.html" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">DOPE</a></li><li class="taxonomy-term-reference-2"><a href="../../category/category/module-development.html" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Module Development</a></li></ul></div>  </div>

  
  
</div>
  </div>
    </div>
  
  
  
  
  
  
</div>  </div>
</div>
  </div>
      
    </div></div> <!-- /.section, /#content -->

          <div id="sidebar-second" class="column sidebar"><div class="section">
          <div class="region region-sidebar-second">
    <div id="block-block-1" class="block block-block">

    <h2>My Main Site</h2>
  
  <div class="content">
    <p><a href="http://brockboland.com/">BrockBoland.com</a></p>
  </div>
</div>
<div id="block-block-8" class="block block-block">

    <h2>Hi!</h2>
  
  <div class="content">
    <p>I'm Brock Boland, and I like Drupal a little more than is socially acceptable.<br /></p><center><a href="../../about.html"><img src="../../sites/default/files/2012/05/smile-fence-150.jpg" width="150" height="150" alt="Bald Brock" title="Bald Brock" /></a></center>
  </div>
</div>
  </div>
      </div></div> <!-- /.section, /#sidebar-second -->
    
  </div></div> <!-- /#main, /#main-wrapper -->

  
  <div id="footer-wrapper"><div class="section">

    
          <div id="footer" class="clearfix">
          <div class="region region-footer">
    <div id="block-block-5" class="block block-block">

    
  <div class="content">
    <p>Content © 2009 - 2012 Brock Boland. Powered by <a href="http://drupal.org/">Drupal</a> because it's great. <a href="http://www.drupal.org" target="_blank">Drupal</a> is a registered trademark of <a href="http://buytaert.net/" target="_blank">Dries Buytaert</a>. The <a href="http://drupal.org/druplicon" target="_blank">Druplicon image</a> is licensed under the <a href="http://drupal.org/licensing/faq" target="_blank">GPL License</a>.</p>
  </div>
</div>
  </div>
      </div> <!-- /#footer -->
    
  </div></div> <!-- /.section, /#footer-wrapper -->

</div></div> <!-- /#page, /#page-wrapper -->
  </body>
</html>
